name: Publish Package

on:
  release:
    types:
      - published

permissions:
  id-token: write # Required for OIDC/trusted publishing
  contents: read

jobs:
  publish:
    if: ${{ github.event.release.prerelease == false }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      # Ensure npm 11.5.1 or later is installed for proper OIDC support
      - name: Update npm
        run: npm install -g npm@latest

      - name: Install dependencies
        run: npm ci

      - name: Derive release version
        id: release_version
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          VERSION="${RELEASE_TAG#refs/tags/}"
          VERSION="${VERSION#v}"
          if [[ -z "$VERSION" ]]; then
            echo "Unable to determine version from release tag '${RELEASE_TAG}'" >&2
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Sync package metadata
        run: |
          CURRENT=$(node -p "require('./package.json').version")
          NEW="${{ steps.release_version.outputs.version }}"
          if [ "$CURRENT" = "$NEW" ]; then
            echo "package.json already at $CURRENT; skipping npm version bump"
          else
            npm version "$NEW" --no-git-tag-version
          fi

      - name: Build library
        run: npm run build

      - name: Publish to npm
        run: npm publish --access public
